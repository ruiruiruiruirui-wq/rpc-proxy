    location ^~ /sumsub/ {
        access_log /etc/nginx/logs/sumsub-access.log rpc-proxy;
        error_log /etc/nginx/logs/sumsub-error.log error;

        access_by_lua_block {
            local api_keys = ngx.shared.api_keys
            local sumsub_app_token = api_keys:get("SUMSUB_APP_TOKEN")
            local sumsub_secret_key = api_keys:get("SUMSUB_SECRET_KEY")
            
            local now = ngx.time()
            local method = string.upper(ngx.var.request_method)
            -- 去掉 /sumsub 前缀，获取实际API路径
            local path_url = ngx.var.request_uri:gsub("^/sumsub", "")
            local body = ngx.var.request_body or ""
            
            -- 按照Sumsub规范构造签名数据：timestamp + method + path + body
            local data_to_sign = tostring(now) .. method .. path_url .. body
            
            -- 使用系统openssl命令计算HMAC-SHA256（如果可用）
            local function calculate_hmac_sha256(key, message)
                -- 转义特殊字符
                local escaped_message = message:gsub("'", "'\"'\"'"):gsub("\\", "\\\\")
                local escaped_key = key:gsub("'", "'\"'\"'"):gsub("\\", "\\\\")
                
                local cmd = string.format("echo -n '%s' | openssl dgst -sha256 -hmac '%s' -hex 2>/dev/null | sed 's/^.* //'", escaped_message, escaped_key)
                local handle = io.popen(cmd)
                if handle then
                    local result = handle:read("*a")
                    handle:close()
                    local sig = result:match("([a-f0-9]+)")
                    return sig
                end
                return nil
            end
            
            local signature = calculate_hmac_sha256(sumsub_secret_key, data_to_sign)
            
            -- 如果openssl不可用，使用占位符（用于调试）
            if not signature then
                signature = "openssl_not_available"
            end
            
            -- 调试日志
            ngx.log(ngx.ERR, "=== SUMSUB DEBUG ===")
            ngx.log(ngx.ERR, "APP_TOKEN: ", sumsub_app_token or "nil")
            ngx.log(ngx.ERR, "SECRET_KEY exists: ", sumsub_secret_key and "yes" or "no")
            ngx.log(ngx.ERR, "Timestamp: ", now)
            ngx.log(ngx.ERR, "Method: ", method)
            ngx.log(ngx.ERR, "Original URI: ", ngx.var.request_uri)
            ngx.log(ngx.ERR, "Path URL: ", path_url)
            ngx.log(ngx.ERR, "Body: ", body)
            ngx.log(ngx.ERR, "Data to sign: ", data_to_sign)
            ngx.log(ngx.ERR, "Calculated signature: ", signature)
            ngx.log(ngx.ERR, "==================")
            
            -- 设置Sumsub API所需的认证头部
            ngx.req.set_header("X-App-Token", sumsub_app_token)
            ngx.req.set_header("X-App-Access-Ts", tostring(now))
            ngx.req.set_header("X-App-Access-Sig", signature)
        }

        proxy_pass https://api.sumsub.com/;

        proxy_set_header Host api.sumsub.com;
        proxy_set_header accept-encoding "identity";
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_ssl_server_name on;
        proxy_redirect off;
    }

